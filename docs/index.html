<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Color War</title>

  <style>
    :root{
      --bg:#0b0f1a;
      --stroke: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 16px;

      --A:#ff4d7d; /* Left color (A / Pink) */
      --B:#40c4ff; /* Right color (B / Blue) */
    }

    html,body{
      margin:0;
      height:100%;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(64,196,255,.18), transparent 60%),
        radial-gradient(1000px 700px at 80% 20%, rgba(255,77,125,.18), transparent 60%),
        var(--bg);
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    canvas{
      width:100vw;
      height:100vh;
      display:block;
    }

    /* ========= TOP HUD ========= */
    .hud{
      position: fixed;
      left: 12px;
      right: 12px;
      top: 12px;
      z-index: 20;
      display:flex;
      justify-content:center;
      pointer-events:none; /* Let the canvas still receive touches; re-enable on panel */
    }

    .panel{
      pointer-events:auto;
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 12px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .leftGroup,.rightGroup{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: conic-gradient(from 180deg, var(--A), var(--B));
      box-shadow: 0 0 16px rgba(255,255,255,.35);
    }

    .title{
      color: var(--text);
      font-weight: 700;
      letter-spacing:.2px;
      font-size: 14px;
      line-height: 1;
    }

    .subtitle{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
      line-height: 1;
    }

    .field{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    label{
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }

    input{
      width: 150px;
      border: none;
      outline:none;
      color: var(--text);
      background: transparent;
      font-size: 14px;
    }
    input.wide{ width: 260px; }

    button{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 9px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.26);
    }
    button:active{ transform: translateY(1px); }

    .btnPrimary{
      background: rgba(64,196,255,.16);
      border-color: rgba(64,196,255,.30);
    }
    .btnPrimary:hover{
      background: rgba(64,196,255,.20);
      border-color: rgba(64,196,255,.40);
    }

    .btnDanger{
      background: rgba(255,77,125,.16);
      border-color: rgba(255,77,125,.30);
    }
    .btnDanger:hover{
      background: rgba(255,77,125,.20);
      border-color: rgba(255,77,125,.40);
    }

    .statusLine{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
    }
    .pill strong{ color: var(--text); font-weight: 700; }

    .help{ opacity:.9; }

    /* ========= CENTER DEBUG OVERLAY (kept) ========= */
    .debug{
      position: fixed;
      left: 50%;
      top: 54%;
      transform: translate(-50%,-50%);
      z-index: 10;
      width: min(420px, calc(100% - 48px));
      pointer-events:none;
      text-align:center;
      color: var(--text);
    }

    .debugCard{
      background: rgba(0,0,0,.34);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 14px 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .debugTop{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .big{
      font-size: 32px;
      font-weight: 800;
      letter-spacing:.2px;
      line-height: 1.05;
      margin: 4px 0 6px;
    }
    .small{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.2;
    }

    .hint{
      margin-top: 10px;
      color: rgba(255,255,255,.75);
      font-size: 12px;
    }
    .hint code{ color: rgba(255,255,255,.92); }

    /* Slightly smaller UI on small screens */
    @media (max-width: 560px){
      input{ width: 120px; }
      input.wide{ width: 200px; }
      .big{ font-size: 28px; }
    }

    /* ===== MOBILE: COLLAPSIBLE HUD (won't block the screen) ===== */
    @media (max-width: 600px){
      /* Default: minimal bar (no screen blocking) */
      .panel{
        padding: 6px 8px;
        border-radius: 14px;
      }

      .brand .subtitle,
      .statusLine,
      label,
      .field{
        display:none; /* Hide details by default on mobile */
      }

      input{ width: 90px; font-size: 12px; }
      input.wide{ width: 140px; }

      button{
        padding: 6px 8px;
        font-size: 12px;
      }

      /* Expanded: show all controls */
      .panel.expanded .field,
      .panel.expanded .statusLine{
        display:flex;
      }
      .panel.expanded label{
        display:inline;
      }
      .panel.expanded .brand .subtitle{
        display:block;
      }
    }
  </style>
</head>

<body>
  <!-- Top control panel -->
  <div class="hud">
    <div class="panel">
      <div class="row">
        <div class="leftGroup">
          <div class="brand">
            <div class="dot"></div>
            <div>
              <div class="title">Color War</div>
              <div class="subtitle">Tilt battle via WebSocket</div>
            </div>
          </div>

          <div class="field">
            <label for="name">Name</label>
            <input id="name" placeholder="e.g. Cindy" />
            <button id="setName" class="btnPrimary">Set Name</button>
          </div>

          <div class="field">
            <label for="room">Room</label>
            <input id="room" value="room1" />
          </div>

          <div class="field">
            <label for="ws">WS</label>
            <input id="ws" class="wide" value="wss://color-war-server.onrender.com" />
          </div>
        </div>

        <div class="rightGroup">
          <!-- Mobile HUD toggle (tap to expand/collapse) -->
          <button id="toggleHud">HUD</button>

          <button id="connect" class="btnPrimary">Connect</button>
          <button id="motion">Enable Motion</button>
          <button id="reset" class="btnDanger">Reset</button>
        </div>
      </div>

      <div class="statusLine">
        <div class="pill"><strong>Me</strong> <span id="meLabel">Unknown</span></div>
        <div class="pill"><strong>Status</strong> <span id="status">Idle</span></div>
        <div class="pill help">
          <span><strong>A</strong> (pink): tilt <code>left</code></span>
          <span>·</span>
          <span><strong>B</strong> (blue): tilt <code>right</code></span>
          <span>·</span>
          <span>neutral tilt returns to center</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Canvas -->
  <canvas id="canvas"></canvas>

  <!-- Center debug overlay (kept) -->
  <div class="debug">
    <div class="debugCard">
      <div class="debugTop">
        <span>role: <strong id="roleTxt">?</strong></span>
        <span>·</span>
        <span>id: <strong id="idTxt">?</strong></span>
        <span>·</span>
        <span>players: <strong id="playersTxt">0</strong></span>
      </div>

      <div class="big">
        raw <span id="rawTxt">0.00</span> · power <span id="powTxt">0.00</span>
      </div>

      <div class="small">
        p <span id="pTxt">0.50</span> · ws <span id="wsTxt">null</span>
      </div>

      <div class="hint">
        Tip: tap <strong>Connect</strong> first (get role), then <strong>Enable Motion</strong>.
      </div>
    </div>
  </div>

<script>
/* =========================
   Color War (Front-end)
   - Hosts the UI and canvas rendering
   - Reads device orientation (gamma)
   - Sends "power" to WebSocket server
   - Receives "state" with p (color split)
   ========================= */

/* Canvas setup */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

/* UI helper */
const $ = (id) => document.getElementById(id);

/* UI elements */
const ui = {
  name: $("name"),
  setName: $("setName"),
  room: $("room"),
  ws: $("ws"),
  connect: $("connect"),
  motion: $("motion"),
  reset: $("reset"),
  status: $("status"),
  meLabel: $("meLabel"),

  toggleHud: $("toggleHud"),

  roleTxt: $("roleTxt"),
  idTxt: $("idTxt"),
  playersTxt: $("playersTxt"),
  rawTxt: $("rawTxt"),
  powTxt: $("powTxt"),
  pTxt: $("pTxt"),
  wsTxt: $("wsTxt"),
};

/* Update status line text */
function setStatus(text){
  ui.status.textContent = text;
}

/* Resize canvas using device pixel ratio for crispness */
function resize(){
  const dpr = window.devicePixelRatio || 1;
  canvas.width  = Math.floor(window.innerWidth * dpr);
  canvas.height = Math.floor(window.innerHeight * dpr);
}
window.addEventListener("resize", resize);
resize();

/* Game state colors */
const COLOR_A = getComputedStyle(document.documentElement).getPropertyValue("--A").trim();
const COLOR_B = getComputedStyle(document.documentElement).getPropertyValue("--B").trim();

/* WebSocket and player state */
let ws = null;
let role = null;       // "A" (left/pink) or "B" (right/blue)
let myId = null;       // id sent to server (includes name)
let myName = "Player"; // user-defined name

/* Motion state */
let motionEnabled = false;
let raw = 0;     // immediate strength [0..1]
let power = 0;   // smoothed strength [0..1]

/* Server state */
let p = 0.5;           // split ratio [0..1]
let players = [];
let winner = null;

/* Load saved name from localStorage */
(function initName(){
  const saved = localStorage.getItem("colorwar_name");
  if(saved && saved.trim()){
    myName = saved.trim().slice(0, 16);
  }
  ui.name.value = myName;
  ui.meLabel.textContent = myName;
})();

/* Save name button */
ui.setName.addEventListener("click", () => {
  const v = (ui.name.value || "").trim().slice(0, 16);
  if(!v){
    setStatus("Please enter a name.");
    return;
  }
  myName = v;
  localStorage.setItem("colorwar_name", myName);
  ui.meLabel.textContent = myName;
  setStatus("Name set. Reconnect to apply.");
});

/* Mobile HUD toggle (collapse/expand) */
ui.toggleHud?.addEventListener("click", () => {
  document.querySelector(".panel")?.classList.toggle("expanded");
});

/* Request motion permission on iOS, then enable motion reading */
async function enableMotion(){
  try{
    if(typeof DeviceOrientationEvent !== "undefined" &&
       typeof DeviceOrientationEvent.requestPermission === "function"){
      await DeviceOrientationEvent.requestPermission();
    }
    motionEnabled = true;
    setStatus("Motion enabled. Tilt your phone.");
  }catch(e){
    motionEnabled = true;
    setStatus("Motion enabled (fallback). If no response, use Safari.");
  }
}
ui.motion.addEventListener("click", enableMotion);

/* Convert device tilt to raw power (directional):
   - A gains power when tilting LEFT
   - B gains power when tilting RIGHT
   - Neutral tilt yields raw = 0 (helps return to center)
*/
window.addEventListener("deviceorientation", (e) => {
  if(!motionEnabled) return;

  const gamma = e.gamma || 0; // left/right tilt; often right positive, left negative
  const dead = 8;             // degrees within this range are considered neutral
  const maxDeg = 55;          // degrees at which we consider "full power"

  /* If role isn't known yet, default to A behavior */
  const signed = (role === "B") ? gamma : -gamma; // tilt toward your side becomes positive

  if(signed < dead){
    raw = 0;
  }else{
    raw = Math.max(0, Math.min(1, (signed - dead) / (maxDeg - dead)));
  }
}, true);

/* Connect to WebSocket server and join a room */
function connect(){
  const room = (ui.room.value || "room1").trim() || "room1";
  const url  = (ui.ws.value || "").trim();

  /* Generate an id that includes the name (simple & readable) */
  const suffix = Math.random().toString(16).slice(2,6);
  myId = `${myName}-${suffix}`;

  /* Close previous socket if it exists */
  if(ws) ws.close();

  try{
    ws = new WebSocket(url);
  }catch(e){
    setStatus("Invalid WebSocket URL.");
    return;
  }

  ui.wsTxt.textContent = "connecting";
  setStatus("Connecting...");

  ws.onopen = () => {
    ui.wsTxt.textContent = "1";
    setStatus(`Connected. Joining room "${room}"...`);
    ws.send(JSON.stringify({ type: "join", room, id: myId }));
  };

  ws.onmessage = (ev) => {
    let d;
    try{ d = JSON.parse(ev.data); }catch{ return; }

    if(d.type === "role"){
      role = d.role;
      ui.roleTxt.textContent = role || "?";
      ui.idTxt.textContent = myId || "?";

      const who = (role === "A")
        ? `${myName} — A (Pink / Left)`
        : `${myName} — B (Blue / Right)`;

      ui.meLabel.textContent = who;
      setStatus(`Joined as ${role}. Now enable motion and tilt.`);
    }

    if(d.type === "state"){
      p = d.p;
      players = d.players || [];
      winner = d.winner || null;

      ui.playersTxt.textContent = String(players.length);
      ui.pTxt.textContent = Number(p).toFixed(2);

      if(winner){
        setStatus(`${winner} wins! Tap Reset to play again.`);
      }
    }
  };

  ws.onerror = () => {
    setStatus("WebSocket error. Check Render status / WS URL.");
  };

  ws.onclose = () => {
    ui.wsTxt.textContent = "null";
    setStatus("Disconnected.");
    role = null;
    winner = null;
    players = [];
    ui.roleTxt.textContent = "?";
    ui.playersTxt.textContent = "0";
  };
}
ui.connect.addEventListener("click", connect);

/* Reset the round */
function reset(){
  if(ws && ws.readyState === 1){
    ws.send(JSON.stringify({ type: "reset" }));
    setStatus("Reset sent.");
  }else{
    setStatus("Not connected.");
  }
}
ui.reset.addEventListener("click", reset);

/* Main loop:
   - smooth motion power
   - send power to server
   - draw the split colors
   - update debug overlay
*/
function loop(){
  /* Smooth the control signal to reduce jitter */
  power += (raw - power) * 0.12;

  /* Send power to server (0..1) */
  if(ws && ws.readyState === 1){
    ws.send(JSON.stringify({ type: "power", value: power }));
  }

  draw();
  updateDebug();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Draw the color battle field */
function draw(){
  const w = canvas.width;
  const h = canvas.height;

  /* If a winner exists, show a dark overlay */
  if(winner){
    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillRect(0,0,w,h);

    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.font = `${Math.floor(48 * (window.devicePixelRatio||1))}px system-ui`;
    ctx.fillText("WINNER", w/2, h/2 - 20*(window.devicePixelRatio||1));
    ctx.font = `${Math.floor(22 * (window.devicePixelRatio||1))}px system-ui`;
    ctx.fillText(String(winner), w/2, h/2 + 20*(window.devicePixelRatio||1));
    ctx.textAlign = "left";
    return;
  }

  /* Draw split colors based on p */
  const aW = Math.floor(w * p);

  ctx.fillStyle = COLOR_A;
  ctx.fillRect(0, 0, aW, h);

  ctx.fillStyle = COLOR_B;
  ctx.fillRect(aW, 0, w - aW, h);

  /* Center line */
  ctx.globalAlpha = 0.22;
  ctx.fillStyle = "white";
  ctx.fillRect(aW - 2, 0, 4, h);
  ctx.globalAlpha = 1;
}

/* Update the center debug overlay values */
function updateDebug(){
  ui.rawTxt.textContent = raw.toFixed(2);
  ui.powTxt.textContent = power.toFixed(2);

  ui.pTxt.textContent = Number(p).toFixed(2);

  if(ws) ui.wsTxt.textContent = String(ws.readyState);
  else ui.wsTxt.textContent = "null";

  ui.roleTxt.textContent = role || "?";
  ui.idTxt.textContent = myId || "?";
  ui.playersTxt.textContent = String(players.length);
}

/* Initial status message */
setStatus("Idle. Set your name, then Connect.");
</script>
</body>
</html>
